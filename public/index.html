<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CryptoFaces - Profile Picture NFT</title>

  <!-- Farcaster Mini App Meta Tags (PASTIKAN DOMAINNYA BENAR) -->
  <meta name="fc:miniapp" content='{
    "version":"1",
    "imageUrl":"https://cryptofaces-nft.vercel.app/images/preview.png",
    "button":{
      "title":"üé® Create Your NFT",
      "action":{
        "type":"launch_miniapp",
        "name":"CryptoFaces",
        "url":"https://cryptofaces-nft.vercel.app",
        "splashImageUrl":"https://cryptofaces-nft.vercel.app/images/splash.png",
        "splashBackgroundColor":"#1e1b4b"
      }
    }
  }'>

  <!-- SEO / Social -->
  <meta name="description" content="Generate unique profile picture NFTs with randomized traits on Farcaster"/>
  <meta property="og:title" content="CryptoFaces NFT"/>
  <meta property="og:description" content="Create and mint unique profile picture NFTs"/>
  <meta property="og:image" content="https://cryptofaces-nft.vercel.app/images/preview.png"/>
  <meta property="og:type" content="website"/>
  <meta name="twitter:card" content="summary_large_image"/>

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes float { 0%,100% {transform: translateY(0)} 50% {transform: translateY(-20px)} }
    .animate-float { animation: float 3s ease-in-out infinite }
    @keyframes pulse { 0%,100% {opacity:1} 50% {opacity:.5} }
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4,0,0.6,1) infinite }
    .hidden { display:none }
    .nft-canvas {
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-950 via-purple-900 to-pink-900">
  <div id="app">
    <div class="min-h-screen flex items-center justify-center">
      <div class="text-white text-xl animate-pulse">Loading CryptoFaces...</div>
    </div>
  </div>

  <!-- Farcaster MiniApp SDK + Storage shim -->
  <script type="module">
    // Import MiniApp SDK (bukan frame-sdk)
    import { sdk } from "https://esm.sh/@farcaster/miniapp-sdk";
    // Ekspos agar bisa dipakai di class
    window.farcasterSDK = sdk;

    // Storage shim: samakan API yang kamu pakai dengan localStorage
    if (!window.storage) {
      window.storage = {
        async get(key) {
          const v = localStorage.getItem(key);
          return v ? { value: v } : null;
        },
        async set(key, value) {
          localStorage.setItem(key, value);
          return true;
        },
        // list(prefix, startsWith=true)
        async list(prefix = "", startsWith = true) {
          const keys = [];
          for (let i = 0; i < localStorage.length; i++) {
            const k = localStorage.key(i);
            if (!prefix) keys.push(k);
            else if (startsWith ? k.startsWith(prefix) : k.includes(prefix)) keys.push(k);
          }
          return { keys };
        }
      };
    }

    // ---- App code (asli kamu, dengan sedikit perbaikan kecil) ----
    class CryptoFacesNFT {
      constructor() {
        this.state = {
          userData: null,
          activeTab: 'create',
          nftPreview: null,
          myNFTs: [],
          allNFTs: [],
          isGenerating: false,
          isMinting: false,
          mintPrice: 0.001, // ETH
          totalSupply: 0,
          traits: {
            background: null,
            face: null,
            eyes: null,
            mouth: null,
            accessory: null
          },
          initialized: false
        };

        this.traitOptions = {
          background: [
            { name: 'Blue Sky', color: '#3b82f6', rarity: 'Common' },
            { name: 'Purple Dream', color: '#a855f7', rarity: 'Common' },
            { name: 'Green Forest', color: '#22c55e', rarity: 'Common' },
            { name: 'Golden Sunset', color: '#f59e0b', rarity: 'Rare' },
            { name: 'Pink Paradise', color: '#ec4899', rarity: 'Rare' },
            { name: 'Dark Matter', color: '#1f2937', rarity: 'Epic' },
            { name: 'Rainbow', gradient: 'linear-gradient(45deg, #f59e0b, #ec4899, #a855f7)', rarity: 'Legendary' }
          ],
          face: [
            { name: 'Happy', emoji: 'üòä', rarity: 'Common' },
            { name: 'Cool', emoji: 'üòé', rarity: 'Common' },
            { name: 'Excited', emoji: 'ü§©', rarity: 'Rare' },
            { name: 'Thinking', emoji: 'ü§î', rarity: 'Rare' },
            { name: 'Robot', emoji: 'ü§ñ', rarity: 'Epic' },
            { name: 'Alien', emoji: 'üëΩ', rarity: 'Epic' },
            { name: 'Diamond', emoji: 'üíé', rarity: 'Legendary' }
          ],
          eyes: [
            { name: 'Normal', emoji: 'üëÄ', rarity: 'Common' },
            { name: 'Laser', emoji: 'üëÅÔ∏è', rarity: 'Rare' },
            { name: 'Hearts', emoji: 'üòç', rarity: 'Rare' },
            { name: 'Stars', emoji: 'ü§©', rarity: 'Epic' },
            { name: '3D Glasses', emoji: 'ü•Ω', rarity: 'Epic' },
            { name: 'Glowing', emoji: '‚ú®', rarity: 'Legendary' }
          ],
          mouth: [
            { name: 'Smile', emoji: 'üòä', rarity: 'Common' },
            { name: 'Big Grin', emoji: 'üòÅ', rarity: 'Common' },
            { name: 'Mustache', emoji: 'ü•∏', rarity: 'Rare' },
            { name: 'Pipe', emoji: 'üö¨', rarity: 'Epic' },
            { name: 'Golden Teeth', emoji: '‚ú®', rarity: 'Legendary' }
          ],
          accessory: [
            { name: 'None', type: 'none', rarity: 'Common' },
            { name: 'Cap', emoji: 'üß¢', rarity: 'Common' },
            { name: 'Crown', emoji: 'üëë', rarity: 'Rare' },
            { name: 'Halo', emoji: 'üòá', rarity: 'Epic' },
            { name: 'Party Hat', emoji: 'üéâ', rarity: 'Rare' },
            { name: 'Unicorn Horn', emoji: 'ü¶Ñ', rarity: 'Legendary' }
          ]
        };

        this.init();
      }

      async init() {
        await this.initUser();
        await this.initFarcasterContext();
        await this.loadUserNFTs();
        await this.loadAllNFTs();
        this.generateRandomNFT();
        this.render();
      }

      async initFarcasterContext() {
        try {
          if (window.farcasterSDK) {
            const context = await window.farcasterSDK.context; // optional: FID/username
            if (context?.user) {
              this.state.userData.fid = context.user.fid;
              this.state.userData.username = context.user.username || this.state.userData.username;
            }
            // ‚¨áÔ∏è WAJIB: beri tahu MiniApp bahwa UI sudah siap (hilangkan splash)
            await window.farcasterSDK.actions.ready();
          }
        } catch (error) {
          console.log('Farcaster context not available', error);
        }
      }

      async initUser() {
        const fid = Math.floor(Math.random() * 10000);
        const walletAddress = `0x${Math.random().toString(16).slice(2).padEnd(40,'0')}`;

        try {
          const stored = await window.storage.get(`user:${fid}`);
          if (stored) {
            this.state.userData = JSON.parse(stored.value);
          } else {
            this.state.userData = {
              fid,
              username: `user${fid}`,
              walletAddress,
              mintedCount: 0,
              joinedAt: Date.now()
            };
            await window.storage.set(`user:${fid}`, JSON.stringify(this.state.userData));
          }
        } catch (error) {
          this.state.userData = {
            fid,
            username: `user${fid}`,
            walletAddress,
            mintedCount: 0,
            joinedAt: Date.now()
          };
        }
        this.state.initialized = true;
      }

      async loadUserNFTs() {
        try {
          const result = await window.storage.get(`nfts:${this.state.userData.fid}`);
          this.state.myNFTs = result ? JSON.parse(result.value) : [];
        } catch {
          this.state.myNFTs = [];
        }
      }

      async loadAllNFTs() {
        try {
          const keys = await window.storage.list('nft:', true);
          if (keys && keys.keys) {
            const nfts = await Promise.all(
              keys.keys.slice(0, 200).map(async (key) => {
                try {
                  const result = await window.storage.get(key, true);
                  return result ? JSON.parse(result.value) : null;
                } catch {
                  return null;
                }
              })
            );
            this.state.allNFTs = nfts.filter(Boolean).sort((a, b) => b.mintedAt - a.mintedAt);
            this.state.totalSupply = this.state.allNFTs.length;
          }
        } catch {
          this.state.allNFTs = [];
        }
      }

      generateRandomNFT() {
        this.state.traits = {
          background: this.randomTrait('background'),
          face: this.randomTrait('face'),
          eyes: this.randomTrait('eyes'),
          mouth: this.randomTrait('mouth'),
          accessory: this.randomTrait('accessory')
        };
        this.state.nftPreview = this.generateNFTData();
      }

      randomTrait(category) {
        const options = this.traitOptions[category];
        const weights = options.map(o => {
          if (o.rarity === 'Common') return 40;
          if (o.rarity === 'Rare') return 25;
          if (o.rarity === 'Epic') return 15;
          if (o.rarity === 'Legendary') return 5;
          return 1;
        });
        const totalWeight = weights.reduce((a, b) => a + b, 0);
        let r = Math.random() * totalWeight;
        for (let i = 0; i < options.length; i++) {
          if (r < weights[i]) return options[i];
          r -= weights[i];
        }
        return options[0];
      }

      generateNFTData() {
        const tokenId = this.state.totalSupply + 1;
        return {
          id: `CFACE-${tokenId}`,
          tokenId,
          traits: { ...this.state.traits },
          owner: this.state.userData.username,
          ownerFid: this.state.userData.fid,
          mintedAt: Date.now(),
          rarity: this.calculateRarity()
        };
      }

      calculateRarity() {
        const rarities = Object.values(this.state.traits).map(t => t.rarity);
        const legendaryCount = rarities.filter(r => r === 'Legendary').length;
        const epicCount = rarities.filter(r => r === 'Epic').length;
        if (legendaryCount >= 3) return 'Legendary';
        if (legendaryCount >= 2 || epicCount >= 3) return 'Epic';
        if (legendaryCount >= 1 || epicCount >= 2) return 'Rare';
        return 'Common';
      }

      async mintNFT() {
        if (this.state.isMinting) return;
        this.state.isMinting = true;
        this.render();

        // simulasi transaksi
        await new Promise(r => setTimeout(r, 1500));

        const nft = this.state.nftPreview;
        try {
          this.state.myNFTs.unshift(nft);
          await window.storage.set(`nfts:${this.state.userData.fid}`, JSON.stringify(this.state.myNFTs));
          await window.storage.set(`nft:${nft.id}`, JSON.stringify(nft), true);
          this.state.userData.mintedCount++;
          await window.storage.set(`user:${this.state.userData.fid}`, JSON.stringify(this.state.userData));
          await this.loadAllNFTs();
          this.state.isMinting = false;
          this.state.activeTab = 'my-nfts';
          this.render();
          this.generateRandomNFT();
          alert('üéâ NFT Minted Successfully!\n\nToken ID: #' + nft.tokenId + '\nRarity: ' + nft.rarity);
        } catch (error) {
          console.error('Mint failed:', error);
          this.state.isMinting = false;
          this.render();
          alert('‚ùå Mint failed. Please try again.');
        }
      }

      setActiveTab(tab) {
        this.state.activeTab = tab;
        this.render();
      }

      renderNFTCard(nft, size = 'large') {
        const sizeClass = size === 'small' ? 'w-32 h-32' : 'w-64 h-64';
        const faceSize = size === 'small' ? 'text-5xl' : 'text-9xl';
        const accessorySize = size === 'small' ? 'text-2xl -top-4' : 'text-5xl -top-8';
        const bgStyle = nft.traits.background.gradient
          ? `background: ${nft.traits.background.gradient};`
          : `background-color: ${nft.traits.background.color};`;
        return `
          <div class="${sizeClass} rounded-2xl overflow-hidden shadow-2xl relative nft-canvas border-4 ${this.getRarityBorder(nft.rarity)}" style="${bgStyle}">
            <div class="absolute inset-0 flex items-center justify-center">
              <div class="text-center relative">
                <div class="${faceSize}">${nft.traits.face.emoji}</div>
                ${nft.traits.accessory.emoji ? `<div class="${accessorySize} absolute left-1/2 transform -translate-x-1/2">${nft.traits.accessory.emoji}</div>` : ''}
              </div>
            </div>
            ${size === 'large' ? `
              <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 p-3">
                <div class="text-white text-center">
                  <div class="text-xs font-mono mb-1">#${nft.tokenId}</div>
                  <div class="text-sm font-bold ${this.getRarityTextColor(nft.rarity)}">${this.getRarityIcon(nft.rarity)} ${nft.rarity}</div>
                </div>
              </div>` : ''
            }
          </div>
        `;
      }

      getRarityIcon(rarity) {
        const icons = { 'Common': '‚ö™', 'Rare': 'üîµ', 'Epic': 'üü£', 'Legendary': 'üü°' };
        return icons[rarity] || '‚ö™';
      }
      getRarityTextColor(rarity) {
        const colors = { 'Common': 'text-gray-300', 'Rare': 'text-blue-400', 'Epic': 'text-purple-400', 'Legendary': 'text-yellow-400' };
        return colors[rarity] || 'text-gray-300';
      }
      getRarityBorder(rarity) {
        const borders = { 'Common': 'border-gray-500', 'Rare': 'border-blue-500', 'Epic': 'border-purple-500', 'Legendary': 'border-yellow-500' };
        return borders[rarity] || 'border-gray-500';
      }

      render() {
        const { userData, activeTab, nftPreview, myNFTs, allNFTs, isMinting, mintPrice, totalSupply, initialized } = this.state;
        if (!initialized) return;
        const app = document.getElementById('app');

        app.innerHTML = `
          <div class="min-h-screen text-white pb-20">
            <!-- Header -->
            <div class="bg-black bg-opacity-40 backdrop-blur-lg p-4 sticky top-0 z-10 border-b border-purple-500">
              <div class="flex justify-between items-center">
                <div>
                  <h1 class="text-2xl font-bold bg-gradient-to-r from-yellow-400 via-pink-500 to-purple-500 bg-clip-text text-transparent">CryptoFaces NFT</h1>
                  <p class="text-sm text-purple-300">@${userData.username}</p>
                </div>
                <div class="text-right">
                  <div class="text-2xl font-bold text-yellow-400">${myNFTs.length}</div>
                  <div class="text-xs text-purple-300">NFTs Owned</div>
                </div>
              </div>
            </div>

            <!-- Tabs -->
            <div class="flex gap-2 p-4">
              <button onclick="app.setActiveTab('create')" class="${activeTab === 'create' ? 'bg-gradient-to-r from-purple-600 to-pink-600 shadow-lg scale-105' : 'bg-white bg-opacity-10 hover:bg-opacity-20'} flex-1 py-3 rounded-xl font-semibold transition-all">üé® Create</button>
              <button onclick="app.setActiveTab('my-nfts')" class="${activeTab === 'my-nfts' ? 'bg-gradient-to-r from-purple-600 to-pink-600 shadow-lg scale-105' : 'bg-white bg-opacity-10 hover:bg-opacity-20'} flex-1 py-3 rounded-xl font-semibold transition-all">üñºÔ∏è My NFTs (${myNFTs.length})</button>
              <button onclick="app.setActiveTab('gallery')" class="${activeTab === 'gallery' ? 'bg-gradient-to-r from-purple-600 to-pink-600 shadow-lg scale-105' : 'bg-white bg-opacity-10 hover:bg-opacity-20'} flex-1 py-3 rounded-xl font-semibold transition-all">üåü Gallery</button>
            </div>

            <div class="p-4">
              <!-- Create -->
              <div class="${activeTab === 'create' ? '' : 'hidden'}">
                <div class="max-w-md mx-auto space-y-6">
                  <div class="flex justify-center animate-float">
                    ${this.renderNFTCard(nftPreview, 'large')}
                  </div>

                  <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl p-4">
                    <h3 class="text-lg font-bold mb-3 text-center">üéØ Traits</h3>
                    <div class="space-y-2 text-sm">
                      ${Object.entries(nftPreview.traits).map(([key, value]) => `
                        <div class="flex justify-between items-center bg-black bg-opacity-30 rounded-lg p-2">
                          <span class="capitalize text-purple-300">${key}</span>
                          <span class="font-bold">${value.name} ${this.getRarityIcon(value.rarity)}</span>
                        </div>
                      `).join('')}
                    </div>
                    <div class="mt-4 text-center">
                      <div class="inline-block px-4 py-2 rounded-full font-bold ${
                        nftPreview.rarity === 'Legendary' ? 'bg-gradient-to-r from-yellow-400 to-orange-500' :
                        nftPreview.rarity === 'Epic' ? 'bg-gradient-to-r from-purple-500 to-pink-500' :
                        nftPreview.rarity === 'Rare' ? 'bg-gradient-to-r from-blue-500 to-cyan-500' :
                        'bg-gray-600'
                      }">
                        ${this.getRarityIcon(nftPreview.rarity)} ${nftPreview.rarity} NFT
                      </div>
                    </div>
                  </div>

                  <div class="space-y-3">
                    <button onclick="app.generateRandomNFT(); app.render();" class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 font-bold py-4 rounded-xl transition-all shadow-lg hover:shadow-cyan-500/50 active:scale-95">
                      üîÑ Generate New Face
                    </button>
                    <button onclick="app.mintNFT()" ${isMinting ? 'disabled' : ''} class="${isMinting ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-emerald-500/50 active:scale-95'} w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 font-bold py-4 rounded-xl transition-all shadow-lg">
                      ${isMinting ? '‚è≥ Minting...' : `üíé Mint NFT (${mintPrice} ETH)`}
                    </button>
                  </div>

                  <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gradient-to-br from-purple-600 to-pink-600 rounded-xl p-4 text-center">
                      <div class="text-3xl font-bold">${totalSupply}</div>
                      <div class="text-xs">Total Minted</div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-600 to-cyan-600 rounded-xl p-4 text-center">
                      <div class="text-3xl font-bold">${myNFTs.length}</div>
                      <div class="text-xs">Your Collection</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- My NFTs -->
              <div class="${activeTab === 'my-nfts' ? '' : 'hidden'}">
                ${myNFTs.length === 0 ? `
                  <div class="text-center py-16">
                    <div class="text-6xl mb-4">üé®</div>
                    <h3 class="text-2xl font-bold mb-2">No NFTs Yet</h3>
                    <p class="text-purple-300 mb-6">Create and mint your first CryptoFace!</p>
                    <button onclick="app.setActiveTab('create')" class="bg-gradient-to-r from-purple-600 to-pink-600 px-6 py-3 rounded-xl font-bold hover:shadow-lg transition-all">Start Creating</button>
                  </div>
                ` : `
                  <div class="grid grid-cols-2 gap-4">
                    ${myNFTs.map(nft => `
                      <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl p-3 hover:scale-105 transition-all cursor-pointer">
                        <div class="flex justify-center mb-3">
                          ${this.renderNFTCard(nft, 'small')}
                        </div>
                        <div class="text-center">
                          <div class="text-xs text-purple-300 mb-1 font-mono">#${nft.tokenId}</div>
                          <div class="text-sm font-bold ${this.getRarityTextColor(nft.rarity)}">
                            ${this.getRarityIcon(nft.rarity)} ${nft.rarity}
                          </div>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                `}
              </div>

              <!-- Gallery -->
              <div class="${activeTab === 'gallery' ? '' : 'hidden'}">
                <div class="mb-4 text-center">
                  <h3 class="text-xl font-bold mb-1">üåü Community Gallery</h3>
                  <p class="text-sm text-purple-300">${totalSupply} CryptoFaces Minted</p>
                </div>
                ${allNFTs.length === 0 ? `
                  <div class="text-center py-16">
                    <div class="text-6xl mb-4">üñºÔ∏è</div>
                    <h3 class="text-xl font-bold mb-2">Gallery is Empty</h3>
                    <p class="text-purple-300">Be the first to mint!</p>
                  </div>
                ` : `
                  <div class="grid grid-cols-2 gap-4">
                    ${allNFTs.map(nft => `
                      <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl p-3 hover:scale-105 transition-all cursor-pointer">
                        <div class="flex justify-center mb-3">
                          ${this.renderNFTCard(nft, 'small')}
                        </div>
                        <div class="text-center">
                          <div class="text-xs text-purple-300 mb-1">by @${nft.owner}</div>
                          <div class="text-sm font-bold ${this.getRarityTextColor(nft.rarity)}">
                            ${this.getRarityIcon(nft.rarity)} ${nft.rarity}
                          </div>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                `}
              </div>
            </div>
          </div>
        `;
      }
    }

    // Boot
    document.addEventListener('DOMContentLoaded', () => {
      window.app = new CryptoFacesNFT();
    });
  </script>
</body>
</html>
